---
title: Keystone - Open Source RISC-V TEE
date: 2025-10-11 15:13:00 +0800
author: LNfromNorth
categories: [TEE]
tags: [TEE, System]
description: TEE概念以及开源项目Keystone介绍
media_subpath: /assets/Keystone/
pin: true
---

![Keystone Logo](keystone-logo.png){: width="666" height="130" }
_Keystone_

> Keystone: An Open Framework for Architecting  Trusted Execution Environments [EuroSys'20][^Keystone]

## TEE

TEE的理念来自于可信计算（Trusted Computing）。可信计算是一个广义的安全理念和体系架构，旨在让计算机系统的为可以被验证、不可被恶意篡改、并且能够证明当前状态是“可信”的。

而TEE（Trusted Execution Enviroment）又称为可信执行环境，是可信计算理念的一种具体实现方式。TEE是一种通过硬件进行隔离的，可以安全执行代码并保护数据的环境。

TEE的主要目的是实现可信程序的安全运行，其中可信程序的组成就是程序本身的数据和代码，他们在运行过程中都被加载到内存中，保护的内容也就是这部分数据和代码所在的内存区域。而为了实现这个保护措施，需要从软硬件上提供支持，比如系统的安全启动，可以进行远程验证，安全存储以及加密等内容。


目前最广为人知的TEE是Intel的**SGX（Software Guard Extensions）**[^SGX]，SGX提供了一种进程内的隔离执行环境，能够保证在其中运行的程序免受攻击，并且具有机密性、完整性和重放保护的保证。不同于SGX中的进程级的隔离方式，ARM基于硬件安全架构**Trustzone**[^TrustZone]提供了一种系统级的TEE框架，通过Trustzone中的安全硬件加持，实现了对于CPU、内存、外设等一系列资源的安全隔离和访问。最近的TEE发展向着虚拟机级的安全隔离发展，被称为**机密虚机**（Confidential Virtual Machine），相较于以上两种隔离方式能够提供的运行时有限的支持，机密虚机的模式能让可信程序拥有一个完整的运行时环境，应用构建更加容易，比如AMD的SEM、Intel的TDX、ARM的CCA以及RISC-V中的COVE。

在RISC-V领域，也一直有不同的TEE出现，在这篇文章中主要就是针对RISC-V架构中的经典TEE--**Keystone**[^Keystone]来展开介绍。由于以上几种架构的分类主要是软件层的抽象，并且在实际的Keystone的实现中，对片上硬件的要求也只有**PMP**（Physical Memory Proctection），所以本文的内容主要围绕软件层面的区别展开。

## Keystone

### Keystone 实现

![Keystone Arch](keystone_overview.webp){: width="800" height="350" .shadow} 
_Keystone Arch_

初看Keystone会给人一种难以理解的直观印象：为什么程序不是运行在操作系统之上？这一点回归TEE的概念就可以轻松解释：安全执行代码并且保护数据的环境。

现代计算机系统中，程序都是运行在操作系统之上，依托于操作系统对于处理器核、内存、外设等资源的管理，让程序能够共享资源的，相互隔离的运行在计算机硬件之上。然而随着计算机系统的不断复杂化，越来越多的特性被加入到操作系统之中，这些特性的背后都是成千上万行代码的支撑，代码量的增多，就意味着有更多出现漏洞的可能。并且操作系统与计算机硬件是两个分离的个体，用户会自行选择自己运行的操作系统，硬件很难对操作系统进行严格的限制，所以往往操作系统产生的安全问题，会造成非常严重的后果。

正是由于这种原因，在TEE的世界里，操作系统往往都是被列入不安全行列的，设计者需要使用各种办法从操作系统手中夺回权限：处理器调度权、内存访问权、设备访问权等等。这也是为什么在Keystone的框架中，Runtime与OS是处于一个并列的关系。要实现这种级别的运行时的构建，并且不借助操作系统的帮助，在不改变ISA的情况下，我们就只能向更高特权级的M-mode进行发送请求。这也是为什么软件架构的底层，是一个运行在最高特权级的SM（Secure Monitor），只有拿到比操作系统更高的权限，才有可能绕过操作系统去做其他的工作。而通过SM调度可信执行程序的本质，就是在从操作系统手中夺走处理器核的执行权，或者也可以叫做调度的权利。

这个就是Keystone实现的第一点关键：**利用RISC-V的特权级架构，实现对操作系统处理器资源管理的脱离，由此构建隔离可信的执行环境**。

实现了脱离操作系统控制之后，当然就是构建可信程序自己的执行环境，这部分内容由Keystone所提供的RT（Runtime）来进行提供，可行程序经过SM的认证，运行在相互独立的Rt之上，由此达成相互隔离的执行环境。

但是也正如前边所提到的，操作系统对于计算机硬件的资源由管理权限，我们虽然拥有了脱离操作系统的执行环境，但是程序本质就是内存中断一段数据，而操作系统对于内存拥有完整的读写权限，我们即使拥有SM与RT配合的可行执行程序构建，仍然避免不了操作系统对于可信程序的代码与数据的窃取。

而此时就需要利用RISC-V平台中的另一个特性**PMP**，他作为一组硬件设计的特权寄存器[^PrivilegeSpec]，仅能在M-mode进行配置。它能够通过配置内存空间的起始地址来划分内存区域，并且给这段区域赋予特定的读写执行权限。在此基础之上，我们就能通过SM的动态配置，将操作系统对于内存的完整访问权限进行限制，夺走它对内存资源的管理权限，由此实现可信程序的代码与数据保护。

这个就是Keystone实现的第二点关键：**利用RISC-V平台的PMP机制，实现对操作系统内存资源管理的脱离，由此构建内存防护的执行环境**。

在上述两点支持下，TEE得以在RISC-V平台上进行运行。

![Software Architecture](soft_arch.png){: width="666" height="200" } 
_Software Architecture_

上图是目前几种TEE的软件形式，比如Intel SGX就是一种进程级TEE，而建立在ARM TrustZone的TEE比如OP-TEE，就是第二种系统级的运行模式，最后一种是目前使用较多的虚拟机级TEE。**Keystone从软件架构上来讲，类似于第二种系统级的模式，但是从运行模式上来看，他仍然是与SGX相同的进程级运行方式**。

首先，每个TA（Trusted Application）必须通过一个HA（Host APP）进行启动，由于TEE的运行时内存环境需要在启动时构建，所以TA的内存空间是通过HA进行分配使用的，二者属于同一个操作系统进程，只不过TA的运行时并非由普通操作系统进行提供。

其次，ARM OP-TEE的系统级软件结构在系统引导时，就分别将Rich OS与Trusted OS进行引导到内存中，Trusted OS在内存中是一个静态的对象，只有在运行TA时，才会进行相关系统调用的支持。而Keystone中的Runtime是一个动态的对象，在没有启动Enclave时，内存中不会存在Runtime进行驻留，Runtime的生命周期伴随TA的生命周期，并且随着多个Enclave的创建，Runtime会在内存中存在多份。

以上就是为什么说Keystone是系统级软件形式但实际为进程级运行模式。

### Keystone 组件

由上述介绍可以得知，Keystone没有依赖其他额外的硬件进行构建，所以整个工作都是软件层面上的内容。

从结构图（Keystone Arch）中也很容易看出，整个系统由一下几个部分进行组成：

1. **Secure Monitor**：运行在M-mode的安全监视器，用来管理Enclave的运行，以及内存、中断，上下文切换等运行时配置，同时向上提供接口，接收来自操作系统或Runtime的请求，对请求进行分发处理。

2. **Runtime**：可行程序的运行时，充当可行执行程序执行时的操作系统。因为EAPP的编译流程与常规程序相同，都需要依赖操作系统支持进行运行，但是TEE中又认为操作系统是不可信的，这样就有了Runtime的位置。它主要向TEE提供一些常用的系统调用接口，以及一些特有的比如密钥获取，证明等手段。

3. **Keystone Driver**：Keystone驱动在图中没有很好的体现，但是如果我们从使用流程来分析的话很容易得出这一个模块：Enclave由SM进行管理，应用程序想要启动Enclave就需要APP与SM通信，这个通信无法穿透操作系统内核进行，自然就需要加载一个Linux Module来完成这个工作，它的作用就是将任务传递到SM中，并且负责与操作系统申请内存与管理的工作。

4. **Keystone SDK**：相应的为了维护与内核交互的接口，在用户态提供了一系列标准的调用接口，利用**ioctl**这样的操作，将任务通过驱动定义的接口发送到SM中，并且对Enclave返回的任务进行处理。

5. **bootrom**：启动固件，保存厂商固化在硬件中的密钥信息。

## 参考

[^Keystone]: https://keystone-enclave.org/
[^SGX]: https://www.intel.com/content/www/us/en/products/docs/accelerator-engines/software-guard-extensions.html
[^TrustZone]: https://developer.arm.com/documentation/102418/0102/What-is-TrustZone-
[^PrivilegeSpec]: https://github.com/riscv/riscv-isa-manual/releases/download/riscv-isa-release-86d87d4-2025-10-30/riscv-privileged.pdf
